---
import { Icon } from 'astro-pure/user'
import { Button } from 'astro-pure/user'
import { getUniqueTags } from 'astro-pure/server'
import PageLayout from '@/layouts/BaseLayout.astro'
import config from '@/site-config'
import { getCollection } from 'astro:content'

const meta = {
  description: 'Publications and research papers by Zhancun Mu',
  title: 'Publications'
}

// Get publications from content collection
const allPublications = await getCollection('publications', ({ data }) => {
  return !data.draft
})

// Sort by publish date (newest first)
const publications = allPublications.sort((a, b) => 
  new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime()
)

// Get unique tags for sidebar
const uniqueTags = getUniqueTags(publications)
---

<PageLayout meta={meta}>
  <div class="w-full">
    <div class="mb-8">
      <p class="text-muted-foreground">
        My published research papers in artificial intelligence, reinforcement learning, and related fields.
        For preprints and working papers, please visit the <a href="/preprints" class="text-primary hover:underline">Preprints</a> page.
      </p>
    </div>

    <div class='grid gap-y-16 sm:grid-cols-[3fr_1fr] sm:gap-x-8'>
      <!-- Main content -->
      <section aria-label='Publications list' class='animate' id='content'>
        <div class="space-y-4">
          {publications.map((pub) => (
            <a 
              href={`/publications/${pub.id}`}
              class="group block"
            >
              <div class="relative rounded-lg border bg-card p-6 transition-all hover:shadow-md">
                <div class="flex gap-6">
                  <!-- Teaser Image -->
                  <div class="flex-shrink-0 w-48">
                    <img 
                      src={pub.data.teaser || '/images/default-paper.jpg'} 
                      alt={`${pub.data.title} teaser`}
                      class="w-full h-36 rounded-md object-cover bg-muted"
                      loading="lazy"
                    />
                  </div>
                  
                  <!-- Publication Details -->
                  <div class="flex-1 flex flex-col justify-between min-h-36">
                    <div class="space-y-3">
                  <!-- Title -->
                  <h3 class="text-base font-semibold leading-tight text-foreground group-hover:text-primary line-clamp-2">
                    {pub.data.title}
                  </h3>
                  
                  <!-- Authors -->
                  <p class="text-xs text-muted-foreground leading-relaxed">
                    {pub.data.authors.map((author, index) => {
                      const isEqualContrib = author.includes('*');
                      const cleanAuthor = author.replace('*', '');
                      const isMe = cleanAuthor === 'Zhancun Mu';
                      return (
                        <span class={isMe ? 'font-medium text-foreground' : ''}>
                          {cleanAuthor}{isEqualContrib ? '*' : ''}{index < pub.data.authors.length - 1 ? ', ' : ''}
                        </span>
                      );
                    })}
                    {pub.data.authors.some(author => author.includes('*')) && (
                      <span class="inline-block text-xs text-amber-700 bg-amber-50/70 px-2 py-0.5 rounded-md mt-2 italic font-light border border-amber-100 equal-contribution">* Equal contribution</span>
                    )}
                  </p>
                  
                  <!-- Venue with Publication Type Badge -->
                  <div class="flex items-center gap-2">
                    <p class="text-xs font-medium text-primary">
                      {pub.data.venue} • {pub.data.year}
                    </p>
                    <span class={`text-xs px-2 py-1 rounded-full font-medium ${
                      pub.data.type === 'conference' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' :
                      pub.data.type === 'journal' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' :
                      'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300'
                    }`}>
                      {pub.data.type}
                    </span>
                  </div>
                </div>
                
                <!-- Links Container -->
                <div class="pt-2">
                  {pub.data.links?.paper && (
                    <a 
                      href={pub.data.links.paper}
                      target="_blank"
                      rel="noopener noreferrer"
                      data-link-button
                      class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors mr-2 mb-1"
                      onclick="event.stopPropagation()"
                    >
                      Paper
                    </a>
                  )}
                  {pub.data.links?.code && (
                    <a 
                      href={pub.data.links.code}
                      target="_blank"
                      rel="noopener noreferrer"
                      data-link-button
                      class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-secondary text-secondary-foreground hover:bg-secondary/90 transition-colors mr-2 mb-1"
                      onclick="event.stopPropagation()"
                    >
                      Code
                    </a>
                  )}
                  {pub.data.links?.project && (
                    <a 
                      href={pub.data.links.project}
                      target="_blank"
                      rel="noopener noreferrer"
                      data-link-button
                      class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-accent text-accent-foreground hover:bg-accent/90 transition-colors mr-2 mb-1"
                      onclick="event.stopPropagation()"
                    >
                      Project
                    </a>
                  )}
                  {pub.data.links?.slides && (
                    <a 
                      href={pub.data.links.slides}
                      target="_blank"
                      rel="noopener noreferrer"
                      data-link-button
                      class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-muted text-muted-foreground hover:bg-muted/90 transition-colors mr-2 mb-1"
                      onclick="event.stopPropagation()"
                    >
                      Slides
                    </a>
                  )}
                  {pub.data.links?.video && (
                    <a 
                      href={pub.data.links.video}
                      target="_blank"
                      rel="noopener noreferrer"
                      data-link-button
                      class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md bg-muted text-muted-foreground hover:bg-muted/90 transition-colors mr-2 mb-1"
                      onclick="event.stopPropagation()"
                    >
                      Video
                    </a>
                  )}
                </div>
                
              </div>
            </div>
          </div>
        </a>
      ))}
        </div>
      </section>

      <!-- sidebar -->
      {!!uniqueTags.length && (
        <aside class='animate' id='sidebar'>
          <h2 class='mb-4 flex items-center text-lg font-semibold'>
            <Icon name='tag-2' class='me-2' />
            Tags
          </h2>
          <ul class='text-bgColor flex flex-wrap gap-2'>
            {uniqueTags.map((tag) => (
              <li>
                <Button title={tag} href={`/tags/${tag}`} style='pill' />
              </li>
            ))}
          </ul>
          <span class='mt-4 block sm:text-end'>
            <a aria-label='View all publication tags' href='/tags' data-astro-prefetch>
              View all →
            </a>
          </span>
        </aside>
      )}
    </div>

    <!-- Footer note -->
    <div class="mt-12 text-center">
      <p class="text-sm text-muted-foreground">
        For the most up-to-date list of publications, please visit my 
        <a href="https://scholar.google.com/citations?user=YOUR_SCHOLAR_ID" class="text-primary hover:underline">
          Google Scholar profile
        </a>.
      </p>
    </div>
  </div>
</PageLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Equal contribution styling for dark mode */
  .dark .equal-contribution {
    background-color: rgb(67 56 202 / 0.1) !important;
    color: rgb(129 140 248) !important;
    border-color: rgb(67 56 202 / 0.3) !important;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 阻止链接按钮的点击事件冒泡
    const linkButtons = document.querySelectorAll('[data-link-button]');
    linkButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    });
  });
</script>
