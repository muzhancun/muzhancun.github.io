---
import { render, type CollectionEntry } from 'astro:content'
import { getCollection } from 'astro:content'
import AcademicLayout from '@/layouts/AcademicLayout.astro'
import { Comment } from 'astro-pure/advanced'
export const prerender = true

export async function getStaticPaths() {
  const publications = await getCollection('publications', ({ data }) => {
    return !data.draft
  })
  
  return publications.map((publication) => ({
    params: { id: publication.id },
    props: { publication }
  }))
}

type Props = {
  publication: CollectionEntry<'publications'>
}

const { publication } = Astro.props
const { Content, headings } = await render(publication)

const meta = {
  description: publication.data.abstract,
  title: publication.data.title
}
---

<AcademicLayout meta={meta}>
  <div class='w-full'>
    
    {/* Header Section */}
    <header class='mb-6 text-center'>
      <h1 class='mb-4 font-sans text-3xl font-semibold leading-tight tracking-tight text-foreground md:text-5xl'>
        {publication.data.title}
      </h1>
      
      <div class='mb-4 flex flex-wrap justify-center gap-x-1 text-lg leading-relaxed'>
        {publication.data.authors.map((author, i) => {
           const isLast = i === publication.data.authors.length - 1
           const cleanAuthor = author.replace('*', '')
           const isMe = cleanAuthor === 'Zhancun Mu'
           return (
             <>
               <span class={isMe ? 'font-medium text-foreground underline decoration-border/50 underline-offset-4' : 'text-muted-foreground'}>
                 {cleanAuthor}{author.includes('*') && '*'}
               </span>
               {!isLast && <span class="text-muted-foreground mr-3">,</span>}
             </>
           )
        })}
      </div>

      <div class='mb-6 flex flex-col items-center gap-2 text-base text-muted-foreground sm:flex-row sm:justify-center'>
        <span class='font-medium italic text-foreground'>{publication.data.venue}</span>
        {publication.data.year && <span class='hidden sm:inline'>â€¢</span>}
        {publication.data.year && <span>{publication.data.year}</span>}
      </div>

      {/* Links */}
      {publication.data.links && Object.keys(publication.data.links).length > 0 && (
        <div class='flex flex-wrap justify-center gap-2'>
           {Object.entries(publication.data.links).map(([key, url]) => (
            <a
              href={url}
              target='_blank'
              rel='noopener noreferrer'
              class='inline-flex items-center justify-center rounded-full border border-border bg-background px-4 py-1.5 text-base font-medium transition-all hover:bg-foreground hover:text-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2'
            >
             {key.charAt(0).toUpperCase() + key.slice(1)}
            </a>
          ))}
        </div>
      )}
    </header>

    {/* Abstract */}
    {publication.data.abstract && (
      <div class='mb-8 rounded-2xl bg-muted/50 p-6'>
         <h2 class='mb-2 font-semibold text-lg text-foreground'>Abstract</h2>
         <p class='text-lg leading-relaxed text-foreground/90'>{publication.data.abstract}</p>
      </div>
    )}

    {/* Teaser Image: Using a more 'Figure 1' style approach */}
    {publication.data.teaser && (
      <figure class='mb-8 flex flex-col items-center gap-2'>
        <div class="relative overflow-hidden rounded-xl border border-border/50 shadow-sm transition-all hover:shadow-md bg-muted/20">
             <img 
               src={publication.data.teaser} 
               alt={`${publication.data.title} teaser`}
               class='max-h-[500px] w-auto h-auto object-contain mx-auto'
               loading='eager'
             />
        </div>
        <figcaption class="text-sm text-muted-foreground text-center italic max-w-[80%]">
           Figure 1: {publication.data.title} Overview
        </figcaption>
      </figure>
    )}

    {/* Main Content: Using system sans font for cleaner look */}
    <article class='prose prose-neutral max-w-none dark:prose-invert prose-headings:font-semibold prose-p:text-justify prose-img:rounded-xl prose-p:text-lg prose-li:text-lg min-h-[20px]'>
      <Content />
    </article>
        
    <div class='mt-8 pt-8 border-t border-dashed border-border/50'>
        <Comment />
    </div>

  </div>  
</AcademicLayout>
