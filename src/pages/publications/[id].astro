---
import { render, type CollectionEntry } from 'astro:content'
import { getCollection } from 'astro:content'
import PageLayout from '@/layouts/BaseLayout.astro'
import { Comment } from 'astro-pure/advanced'
export const prerender = true

export async function getStaticPaths() {
  const publications = await getCollection('publications', ({ data }) => {
    return !data.draft
  })
  
  return publications.map((publication) => ({
    params: { id: publication.id },
    props: { publication }
  }))
}

type Props = {
  publication: CollectionEntry<'publications'>
}

const { publication } = Astro.props
const { Content, headings } = await render(publication)

const meta = {
  description: publication.data.abstract,
  title: publication.data.title
}
---

<PageLayout meta={meta}>
  <div class="w-full max-w-4xl mx-auto">
    <!-- Paper Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-4">{publication.data.title}</h1>
      
      <!-- Authors -->
      <div class="mb-4">
        <p class="text-lg text-muted-foreground">
          {publication.data.authors.map((author, index) => {
            const isEqualContrib = author.includes('*');
            const cleanAuthor = author.replace('*', '');
            const isMe = cleanAuthor === 'Zhancun Mu';
            return (
              <span class={isMe ? 'font-medium text-foreground' : ''}>
                {cleanAuthor}{isEqualContrib ? '*' : ''}{index < publication.data.authors.length - 1 ? ', ' : ''}
              </span>
            );
          })}
        </p>
        {publication.data.authors.some(author => author.includes('*')) && (
          <p class="text-sm text-amber-700 bg-amber-50/70 px-2 py-1 rounded-md mt-2 italic inline-block border border-amber-100">
            * Equal contribution
          </p>
        )}
      </div>
      
      <!-- Venue, Year, and Type -->
      <div class="flex items-center gap-3 mb-4">
        <p class="text-lg font-medium text-muted-foreground">
          {publication.data.venue} ‚Ä¢ {publication.data.year}
        </p>
        <span class={`text-sm px-3 py-1 rounded-full font-medium ${
          publication.data.type === 'conference' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' :
          publication.data.type === 'journal' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' :
          'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300'
        }`}>
          {publication.data.type}
        </span>
      </div>
      
      <!-- Links -->
      <div class="flex flex-wrap gap-3 mb-6">
        {publication.data.links?.paper && (
          <a 
            href={publication.data.links.paper}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-primary text-primary-foreground hover:bg-primary/90 transition-colors"
          >
            üìÑ Paper
          </a>
        )}
        {publication.data.links?.code && (
          <a 
            href={publication.data.links.code}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-secondary text-secondary-foreground hover:bg-secondary/90 transition-colors"
          >
            üíª Code
          </a>
        )}
        {publication.data.links?.project && (
          <a 
            href={publication.data.links.project}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-accent text-accent-foreground hover:bg-accent/90 transition-colors"
          >
            üåê Project
          </a>
        )}
        {publication.data.links?.slides && (
          <a 
            href={publication.data.links.slides}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-muted text-muted-foreground hover:bg-muted/90 transition-colors"
          >
            üìä Slides
          </a>
        )}
        {publication.data.links?.video && (
          <a 
            href={publication.data.links.video}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-muted text-muted-foreground hover:bg-muted/90 transition-colors"
          >
            üé• Video
          </a>
        )}
      </div>
      
      <!-- Teaser Image -->
      {publication.data.teaser && (
        <div class="mb-8">
          <img 
            src={publication.data.teaser} 
            alt={`${publication.data.title} teaser`}
            class="w-full max-w-2xl mx-auto rounded-lg shadow-lg"
            loading="lazy"
          />
        </div>
      )}
    </div>
    
    <!-- Paper Content -->
    <div class="prose prose-lg max-w-none">
      <Content />
    </div>
    
    <!-- Back Navigation -->
    <div class="mt-12 pt-8 border-t">
      <a 
        href="/publications" 
        class="inline-flex items-center gap-2 text-primary hover:underline"
      >
        ‚Üê Back to Publications
      </a>
    </div>

    <Comment />
  </div>  
</PageLayout>

<style>
  /* Equal contribution styling for dark mode */
  .dark .equal-contribution {
    background-color: rgb(67 56 202 / 0.1) !important;
    color: rgb(129 140 248) !important;
    border-color: rgb(67 56 202 / 0.3) !important;
  }
</style>
