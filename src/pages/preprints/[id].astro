---
import { render, type CollectionEntry } from 'astro:content'
import { getCollection } from 'astro:content'
import AcademicLayout from '@/layouts/AcademicLayout.astro'
import { Comment } from 'astro-pure/advanced'
export const prerender = true

export async function getStaticPaths() {
  const preprints = await getCollection('preprints', ({ data }) => {
    return !data.draft
  })
  
  return preprints.map((preprint) => ({
    params: { id: preprint.data.slug || preprint.id },
    props: { preprint }
  }))
}

type Props = {
  preprint: CollectionEntry<'preprints'>
}

const { preprint } = Astro.props
const { Content, headings } = await render(preprint)

const meta = {
  description: preprint.data.abstract,
  title: preprint.data.title
}
---

<AcademicLayout meta={meta}>
  <div class='w-full'>
    
    {/* Header Section */}
    <header class='mb-6 text-center'>
      <h1 class='mb-4 font-sans text-3xl font-semibold leading-tight tracking-tight text-foreground md:text-5xl'>
        {preprint.data.title}
      </h1>
      
      <div class='mb-4 flex flex-wrap justify-center gap-x-1 text-lg leading-relaxed'>
        {preprint.data.authors.map((author, i) => {
           const isLast = i === preprint.data.authors.length - 1
           const cleanAuthor = author.replace('*', '')
           const isMe = cleanAuthor === 'Zhancun Mu'
           return (
             <>
               <span class={isMe ? 'font-medium text-foreground underline decoration-border/50 underline-offset-4' : 'text-muted-foreground'}>
                 {cleanAuthor}{author.includes('*') && '*'}
               </span>
               {!isLast && <span class="text-muted-foreground mr-3">,</span>}
             </>
           )
        })}
      </div>

      <div class='mb-6 flex flex-col items-center gap-2 text-base text-muted-foreground sm:flex-row sm:justify-center'>
        <span class='font-medium italic text-foreground'>{preprint.data.venue || 'Preprint'}</span>
        {preprint.data.year && <span class='hidden sm:inline'>â€¢</span>}
        {preprint.data.year && <span>{preprint.data.year}</span>}
      </div>

      {/* Links */}
      {preprint.data.links && Object.keys(preprint.data.links).length > 0 && (
        <div class='flex flex-wrap justify-center gap-2'>
           {Object.entries(preprint.data.links).map(([key, url]) => (
            <a
              href={url}
              target='_blank'
              rel='noopener noreferrer'
              class='inline-flex items-center justify-center rounded-full border border-border bg-background px-4 py-1.5 text-base font-medium transition-all hover:bg-foreground hover:text-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2'
            >
             {key.charAt(0).toUpperCase() + key.slice(1)}
            </a>
          ))}
        </div>
      )}
    </header>

    {/* Abstract */}
    {preprint.data.abstract && (
      <div class='mb-8 rounded-2xl bg-muted/50 p-6'>
         <h2 class='mb-2 font-semibold text-lg text-foreground'>Abstract</h2>
         <p class='text-lg leading-relaxed text-foreground/90'>{preprint.data.abstract}</p>
      </div>
    )}

    {/* Teaser Image: Using a more 'Figure 1' style approach */}
    {preprint.data.teaser && (
      <figure class='mb-8 flex flex-col items-center gap-2'>
        <div class="relative overflow-hidden rounded-xl border border-border/50 shadow-sm transition-all hover:shadow-md bg-muted/20">
             <img 
               src={preprint.data.teaser} 
               alt={`${preprint.data.title} teaser`}
               class='max-h-[500px] w-auto h-auto object-contain mx-auto'
               loading='eager'
             />
        </div>
        <figcaption class="text-sm text-muted-foreground text-center italic max-w-[80%]">
           Figure 1: {preprint.data.title} Overview
        </figcaption>
      </figure>
    )}

    {/* Main Content: Using system sans font for cleaner look */}
    <article class='prose prose-neutral max-w-none dark:prose-invert prose-headings:font-semibold prose-p:text-justify prose-img:rounded-xl prose-p:text-lg prose-li:text-lg'>
      <Content />
    </article>
        
  </div>
</AcademicLayout>
